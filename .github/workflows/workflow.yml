name: Deploy Spring Boot to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # üß± 1. R√©cup√©ration du code source
      - name: Checkout code
        uses: actions/checkout@v3

      # ‚òï 2. Configuration de Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # üß∞ 3. Build du projet
      - name: Build with Maven
        run: |
          set -e
          mvn clean package -DskipTests

      # üîç 4. V√©rification du dossier target/
      - name: Check build output
        run: ls -lah target

      # üì¶ 5. Copie du fichier .jar sur le VPS
      - name: Copy JAR to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "target/*.jar"
          target: "/root/dvente-api"
          strip_components: 1

      # ‚öôÔ∏è 6. Copie du fichier .env sur le VPS
      - name: Copy .env file to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: ".env"
          target: "/root/dvente-api"

      # üöÄ 7. D√©ploiement et red√©marrage du service sur le VPS
      - name: Deploy on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /root/dvente-api
            
            echo "‚û°Ô∏è D√©ploiement en cours sur le VPS..."

            # Sauvegarde de l'ancienne version si elle existe
            if [ -f app.jar ]; then
              echo "Sauvegarde de l'ancienne version..."
              mv app.jar app.jar.backup
            fi

            # Renommer le nouveau jar
            mv *.jar app.jar

            echo "üîÑ Red√©marrage du service springboot-app..."
            systemctl restart springboot-app

            # Attente du red√©marrage
            sleep 10

            # V√©rification du statut
            if systemctl is-active --quiet springboot-app; then
              echo "‚úÖ D√©ploiement r√©ussi !"
              rm -f app.jar.backup
            else
              echo "‚ùå √âchec du d√©ploiement, restauration de la version pr√©c√©dente..."
              if [ -f app.jar.backup ]; then
                mv app.jar.backup app.jar
                systemctl restart springboot-app
              fi
              exit 1
            fi

      # ‚ù§Ô∏è 8. Health Check de l‚Äôapplication
      - name: Health Check
        run: |
          echo "‚è≥ V√©rification du statut de sant√© de l'application..."
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_HOST }}:8080/actuator/health || echo "000")
          if [ "$response" == "200" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "üö® Health check failed with status: $response"
            exit 1
          fi
