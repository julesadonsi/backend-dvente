name: Deploy Spring Boot to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Copy JAR to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "target/*.jar"
          target: "/root/dvente-api"
          strip_components: 1

      - name: Copy .env file to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: ".env"
          target: "/root/dvente-api"

      - name: Deploy on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /root/dvente-api
            
            # Backup de l'ancienne version
            if [ -f app.jar ]; then
              mv app.jar app.jar.backup
            fi
            
            # Renommer le nouveau JAR
            mv *.jar app.jar
            
            # Redémarrer le service
            systemctl restart springboot-app
            
            # Attendre que l'application démarre
            sleep 10
            
            # Vérifier que l'application est démarrée
            if systemctl is-active --quiet springboot-app; then
              echo "Deployment successful!"
              # Supprimer le backup si tout va bien
              rm -f app.jar.backup
            else
              echo "Deployment failed! Rolling back..."
              # Restaurer l'ancienne version
              if [ -f app.jar.backup ]; then
                mv app.jar.backup app.jar
                systemctl restart springboot-app
              fi
              exit 1
            fi

      - name: Health Check
        run: |
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VPS_HOST }}:8080/actuator/health || echo "000")
          if [ "$response" == "200" ]; then
            echo "Health check passed!"
          else
            echo "Health check failed with status: $response"
            exit 1
          fi