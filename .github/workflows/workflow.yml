name: Deploy Spring Boot to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # üß± 1. R√©cup√©ration du code source
      - name: Checkout code
        uses: actions/checkout@v3

      # ‚òï 2. Configuration de Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # üß∞ 3. Build du projet
      - name: Build with Maven
        run: |
          set -e
          mvn clean package -DskipTests

      # üîç 4. V√©rification du dossier target/
      - name: Check build output
        run: ls -lah target

      # üì¶ 5. Copie du fichier .jar sur le VPS
      - name: Copy JAR to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "target/*.jar"
          target: "/root/dvente-api"
          strip_components: 1


      - name: Deploy on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /root/dvente-api
            
            echo "‚û°Ô∏è D√©ploiement en cours sur le VPS..."

            # Sauvegarde de l'ancienne version si elle existe
            if [ -f app.jar ]; then
              echo "Sauvegarde de l'ancienne version..."
              mv app.jar app.jar.backup
            fi

            # Renommer le nouveau jar
            mv *.jar app.jar

            echo "üîÑ Red√©marrage du service springboot-app..."
            systemctl restart springboot-app

            sleep 10