name: Deploy Spring Boot to VPS

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ğŸ§± 1. RÃ©cupÃ©ration du code source
      - name: Checkout code
        uses: actions/checkout@v4

      # â˜• 2. Configuration de Java 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # ğŸ§° 3. Build du projet
      - name: Build with Maven
        run: |
          set -e
          mvn clean package -DskipTests

      # ğŸ” 4. VÃ©rification du dossier target/
      - name: Check build output
        run: |
          ls -lah target
          if [ ! -f target/*.jar ]; then
            echo "âŒ Aucun fichier JAR trouvÃ©!"
            exit 1
          fi

      # ğŸ“¦ 5. Copie du fichier .jar sur le VPS
      - name: Copy JAR to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "target/*.jar"
          target: "/root/dvente-api"
          strip_components: 1
          timeout: 300s

      # ğŸš€ 6. DÃ©ploiement sur le VPS
      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 300s
          script: |
            set -e
            cd /root/dvente-api
            
            echo "â¡ï¸ DÃ©ploiement en cours sur le VPS..."
            
            # VÃ©rification que le fichier JAR existe
            JAR_FILE=$(ls -1 *.jar 2>/dev/null | head -n 1)
            if [ -z "$JAR_FILE" ]; then
              echo "âŒ Aucun fichier JAR trouvÃ© dans /root/dvente-api"
              exit 1
            fi
            
            echo "ğŸ“¦ Fichier JAR dÃ©tectÃ©: $JAR_FILE"
            
            # Sauvegarde de l'ancienne version si elle existe
            if [ -f app.jar ]; then
              echo "ğŸ’¾ Sauvegarde de l'ancienne version..."
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              mv app.jar "app.jar.backup_$TIMESTAMP"
            
              # Garder seulement les 3 derniÃ¨res sauvegardes
              ls -t app.jar.backup_* 2>/dev/null | tail -n +4 | xargs -r rm
            fi
            
            # Renommer le nouveau jar
            mv "$JAR_FILE" app.jar
            
            echo "ğŸ”„ RedÃ©marrage du service springboot-app..."
            systemctl restart springboot-app
            
            # Attendre le dÃ©marrage
            echo "â³ Attente du dÃ©marrage de l'application..."
            sleep 15
            
            # VÃ©rification du statut du service
            if systemctl is-active --quiet springboot-app; then
              echo "âœ… Service dÃ©marrÃ© avec succÃ¨s!"
              systemctl status springboot-app --no-pager
            else
              echo "âŒ Ã‰chec du dÃ©marrage du service!"
              echo "ğŸ“‹ Logs du service:"
              journalctl -u springboot-app -n 50 --no-pager
              exit 1
            fi

      # ğŸ‰ 7. Notification de succÃ¨s
      - name: Deployment successful
        if: success()
        run: echo "ğŸ‰ DÃ©ploiement rÃ©ussi sur le VPS!"

      # âš ï¸ 8. Notification d'Ã©chec
      - name: Deployment failed
        if: failure()
        run: |
          echo "âŒ Le dÃ©ploiement a Ã©chouÃ©. VÃ©rifiez les logs ci-dessus."
          exit 1